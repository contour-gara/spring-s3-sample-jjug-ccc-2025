# テストは必要なのか

- 変更に強い
  - ライブラリアップデートも変更
  - aws sdk の変更は早い
- 書いたコードが信頼できるものか
- TDD を実践すると、自然とテストしやすい設計になる

## テストのポイント

- 入力
- 出力
- 保存
- 計算

## リポジトリのテストを書く重要性

- 入力
- 出力
- 保存

# リポジトリのテストがどうしてかかれていないか

## S3 を使うクラスを本当にテストをするべきなのか

- ロジックがなければいいのでは？
  - aws のライブラリを使ってるだけ
- 署名付き url の例
  - バケット•オブジェクトがなくても作成できる
- オブジェクト保存でも例外ハンドリングはある
  - 堅牢なコードのほとんどはエラーハンドリング

## 技術的な課題

- クリーンアーキテクチャを平らにした図を示したい
- ドメイン•リポジトリは端っこ
- ドメインは純関数
- リポジトリは外部サービスがあるから難しい

## テストダブル

- クリーンクラフトマンシップの図
- ダミー•スタブ•モック•スパイ
  - 実装クラスのテストダブル
  - インターフェースともいう
- フェイク
  - 外部サービスとして振る舞える
  - 保存のテスト機構はないので、自力でなんとかする

## LocalStack

- docker で aws を再現

# テスト戦略

## テストピラミッド

- ピラミッドの図
- 個人的な解釈は、レイヤー境界を跨ぐかどうか

## テストスコープ

- スコープの図

## 結局何をどこに書くのか

- 3x3 の図
- localstack を使う UT はコスパ悪い
- 結合すると、整合性の取れたデータ準備のコスト
- UT
  - 境界値テスト
  - コスパが悪いと認識しながらも
- 結合テスト
  - ハッピーパス
  - UT ではできない例外処理

# demo

demo する

## AWS のコンフィグクラス

- アプリケーションのプロパティとしておくことでテストがしやすくなる

# UT

- 入出力の確認
- 保存の確認
  - 今回ふれない

## Testcontainers

- 依存関係
- コード
- イメージ選定
- プロパティ設定

## endpoint

- インフラの漏洩になりかねないからプロファイルはなるべく使わない

## データ準備と後処理

- 単体テストの使い方を引用
- S3Client をテストクラスで扱う必要あり
- バケット•オブジェクトの全削除
  - 毎回
- バケット•オブジェクトの作成
  - テストごと
- テストがおおければ、Util クラスにしてもいいかも

# IT

## docker cmopose

- ローカルで動確する環境をそのまま使う

## 各種 plugin

- falsafe
- docker-compose
- mvn clean verify で実行できる。

## pathStyle

# まとめ
